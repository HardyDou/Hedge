# 密码本 产品需求文档 (PRD)

**状态:** 开发中 (In Development)
**最后更新:** 2026-02-26
**应用名称:** 密码本 (Password Vault)

## 1. 背景与问题 (Context & Problem)

### 1.1 为什么做这个？ (Why)
目前的密码管理市场两极分化：
*   **商业软件 (1Password, LastPass):** 功能强大但订阅昂贵，且数据存储在厂商服务器，存在潜在的数据泄露风险（如 LastPass 泄露事件）。
*   **开源软件 (KeePass, Bitwarden 自建):** KeePass 体验较古老，同步配置复杂；Bitwarden 自建需要维护服务器，门槛高。

**密码本**的核心价值在于**"极简且安全"**：
*   **数据绝对掌控:** 没有任何厂商服务器，数据文件由用户自己保管（iCloud/厂商云）。
*   **零成本维护:** 无需购买服务器，无需订阅费。
*   **原生体验:** 采用 iOS 设计规范，提供现代化 UI/UX。

### 1.2 为什么现在做？ (Why Now)
*   **用户隐私意识觉醒:** 越来越多用户倾向于“本地优先 (Local-First)”的软件架构。
*   **云服务普及:** iCloud Drive 和各类手机厂商云服务已高度成熟，为“无服务器同步”提供了完美的基础设施。
*   **跨平台需求:** 用户拥有多台设备（Mac + Android 手机）的场景日益普遍，需要一个轻量级的跨生态解决方案。

---

## 2. 成功指标 (Success Metrics)

*   **核心体验:**
    *   **同步成功率:** 跨设备（iOS <-> Android）修改密码后，另一端同步延迟 < 30秒（依赖云服务推送）。
    *   **解锁速度:** 冷启动至进入主界面 < 1秒。
*   **用户价值:**
    *   **零数据丢失:** 极端情况下（如同步冲突），必须保留冲突副本，绝不覆盖用户数据。
    *   **迁移顺滑:** 从主流竞品（Chrome/1Password）导入成功率 > 95%。

---

## 3. 用户故事 (User Stories)

### 3.1 核心场景
*   **作为** 一名拥有 iPhone 和 MacBook 的用户，**我想要** 在 Mac 上保存的密码自动出现在 iPhone 上，**以便于** 我无需手动传输即可登录 APP。
*   **作为** 一名 Android 用户，**我想要** 使用指纹快速解锁查看密码，**以便于** 在超市结账时快速找到会员卡号。
*   **作为** 一名注重隐私的用户，**我想要** 确信我的密码库文件只存在于我信任的云盘中，**而不被** 任何第三方应用开发商获取。
*   **作为** 一名新用户，**我想要** 一键导入我在 Chrome 浏览器保存的所有密码，**以便于** 我能立即开始使用而无需手动输入。
*   **作为** 一名多设备用户，**当** 我在两台设备同时修改了同一个账号密码时，**我希望** 系统能保留两个版本并提示我，**而不是** 悄悄覆盖掉其中一个。

---

## 4. 功能需求 (Functional Requirements)

### 4.1 核心数据结构 (Vault Item)
每个条目（Item）应包含以下字段：
*   **标题 (Title):** 必填，用于列表展示。
*   **账号/用户名 (Username):** 选填。
*   **密码 (Password):** 
    *   **文本密码:** 支持隐藏/显示，支持随机密码生成器，支持详情页全屏放大显示。
    *   **证书/文件:** 支持存储数字证书文件（如 .p12, .key, .pem）或其他敏感文件附件，支持直接打开附件。
*   **网址 (URL):** 选填，支持点击跳转。
*   **备注 (Notes):** 支持多行文本，用于记录安全问题、恢复码等。
*   **分类/标签 (Category/Tags):** 用于筛选和组织。
*   **附件 (Attachments):** 支持存储多个文件附件。
*   **修改时间 (Updated At):** 用于同步冲突解决。

### 4.2 账户与安全 (Security)
*   **主密码 (Master Password):** 用户首次启动需设置主密码。主密码用于加密本地数据库（Vault）。
*   **生物识别解锁:** 
    *   iOS/macOS: 支持 FaceID / TouchID。
    *   Android: 支持指纹识别 / 面部识别 (BiometricPrompt API)。
    *   支持在设置中开启/关闭生物识别，并在解锁失败时显示具体错误信息。
*   **零知识架构:** 应用不上传任何明文数据。所有数据在写入存储前必须经过 AES-256 (或更高标准如 XChaCha20-Poly1305) 加密。
*   **自动锁屏:** 
    *   应用切后台或闲置一定时间后自动锁定。
    *   支持在设置中配置自动锁屏延迟时间 (1-10 秒可调，默认 5 秒)。
    *   **实现说明:** 使用 `WidgetsBindingObserver` 监听应用生命周期，在 `AppLifecycleState.paused` 时立即检查超时并锁定，确保锁屏生效。

*   **忘记密码处理:**
    *   **生物识别重置:** 如果设备已开启生物识别（FaceID/TouchID/指纹），可通过生物识别验证身份后重置主密码。
    *   **重建密码库:** 如果没有生物识别，只能清除旧数据并创建新密码库（旧密码库会自动备份为 `vault_backup.db`）。

### 4.3 数据存储与同步 (Storage & Sync)

#### 4.3.1 架构策略
采用 **“加密文件库 (File-Based Vault)”** 策略。应用操作一个加密的数据库文件，所有敏感字段加密存储，仅公开必要的元数据（如 UUID, UpdatedAt）用于同步校验。

#### 4.3.2 冲突解决 (Conflict Resolution)
由于无服务端仲裁，当检测到多端同时修改导致冲突时：
*   **策略:** **保留冲突副本 (Keep Both)**。应用会自动将冲突的远程文件重命名并下载到本地。
*   **用户介入:** 提示用户发现冲突，并提供简单的合并界面。

#### 4.3.3 离线支持 (Offline Mode)
*   **完全读写:** 应用优先读写本地缓存文件，在离线状态下所有功能均可用。
*   **自动恢复:** 网络恢复后，依赖底层云服务（iCloud/厂商云）自动触发文件同步。

#### 4.3.4 跨平台同步行为
*   **存储位置自动化**: 存储位置由程序自动选择平台特定位置（iOS/macOS 默认使用 `Documents` 目录以支持 iCloud 同步；Android 默认使用应用私有存储，依赖厂商云备份或用户自行同步）。此选项在设置中仅显示，不可手动更改。
*   **Apple 生态 (macOS / iOS):**
    *   **iCloud Drive 集成:** 密码库文件自动同步至用户的 iCloud Drive。当 iCloud 未激活或未开启对本应用的同步时，设置页面会显示相应的同步状态提示。
*   **Android 生态:**
    *   **厂商云兼容:** 密码库文件存储在应用私有空间，依赖安卓系统自带的备份/同步服务实现（如小米云、华为云、三星云）。
*   **Linux 生态:**
    *   **本地文件管理:** 用户指定数据库路径，需自行使用第三方工具（如 Dropbox, Syncthing, Nextcloud）进行同步。

### 4.4 密码管理功能
*   **增删改查:** 创建、编辑、删除、搜索（支持实时搜索明文标题、用户名及备注关键词）。
*   **数据迁移 (Import/Export):**
    *   **导入:** 支持从 Chrome CSV, 1Password (1PUX/CSV - 智能解析表头), Bitwarden (JSON) 导入数据。导入功能移至“设置”页面。
*   **多语言支持 (i18n):** 支持简体中文、英文，应用启动时默认跟随系统语言，可在设置中切换。
*   **主题管理:** 
    *   支持三种模式：跟随系统、暗黑模式 (Dark)、白天模式 (Light)。
    *   默认为“跟随系统”，可在设置中切换。
*   **添加密码交互 (页面式):** 提供一个独立的“新增条目”页面，支持完整录入：标题、账号、密码、URL、备注及附件。
*   **详情页功能**: 
    *   支持密码隐藏/显示，并提供全屏放大显示密码功能。
    *   支持一键复制所有内容（用户名、密码、网址、备注按换行组合）。
    *   支持附件的直接打开。
*   **本地备份:** 每次重大修改前，自动在本地沙盒保留最近 5 份历史快照，防止文件损坏。
*   **密码生成器:** 自定义长度、字符类型。
*   **剪贴板管理:** 复制密码后，一定时间（如 60秒）自动清空剪贴板。

### 4.5 首次使用流程 (Onboarding)
1.  **欢迎页:** 介绍核心价值（安全、私有）。
2.  **创建主密码:** 强制高强度密码检查，并确保密码匹配和长度要求，提供本地化错误提示。
3.  **自动配置存储位置**: 程序自动选择并配置合适的存储路径（如 iOS 的 `Documents` 目录）。不再需要用户手动选择。
4.  **导入数据 (可选):** 成功创建密码库后，自动弹窗引导用户是否从 CSV 文件导入现有密码。
5.  **进入主界面。**

### 4.6 设置 (Settings)
*   **外观**: 
    *   **主题模式**: 可选择"跟随系统"、"深色模式"、"白天模式"。
    *   **语言**: 可选择"跟随系统"、"English"、"简体中文"。
*   **数据**: 
    *   **导入**: 允许用户从 CSV 文件导入密码（格式：标题/账号/密码/备注）。
*   **安全**: 
    *   **生物识别**: 开启/关闭生物识别解锁。
    *   **自动锁屏延迟**: 通过滑动条设置应用切后台后自动锁定的时间 (1-10 秒，默认 5 秒)。
    *   **重置密码**: 支持在已知原密码的情况下修改主密码。
*   **关于**: 显示应用名称和版本号。


---

## 5. 非功能需求 (Non-Functional Requirements)

### 5.1 安全性 (Security)
*   **加密算法:** 使用工业级标准加密（推荐 AES-256-GCM 或 XChaCha20-Poly1305）。
*   **密钥派生:** 使用 Argon2id 或 PBKDF2 对主密码进行哈希处理，防止暴力破解。
*   **本地存储:** 即使在同步失败时，本地也必须保留完整副本。

### 5.2 性能 (Performance)
*   **启动速度:** 冷启动至解锁界面 < 1秒。
*   **解密速度:** 验证主密码并加载列表 < 1秒（对于常规数据量 < 5000 条）。
*   **大文件优化:** 当数据库大小 > 5MB (约 10,000+ 条目) 时，应采用流式解密或懒加载列表，避免 UI 卡顿。

### 5.3 兼容性 (Compatibility)
*   **iOS:** iOS 15.0+
*   **macOS:** macOS 12.0+ (支持 Apple Silicon & Intel)
*   **Android:** Android 10.0+ (API Level 29+, 确保完善的 SAF 支持)
*   **Linux:** 主流发行版 (Ubuntu, Fedora, Arch)，提供 AppImage 或 Flatpak。

---

## 6. 不在范围 (Out of Scope)

*   **团队共享/企业版:** 不支持多用户共享密码库。
*   **浏览器插件:** MVP 阶段暂不开发 Chrome/Safari 插件，优先保证 App 体验。
*   **云端备份:** 我们不提供任何云存储服务，用户必须自己负责数据的云端备份（通过 iCloud/手机厂商云）。

---

## 7. UI/UX 概览 (UI/UX Guidelines)

*   **设计风格:** iOS 设计规范 (Apple Human Interface Guidelines)。所有页面采用 Cupertino Widgets，确保原生 iOS 体验。
*   **设计原则:**
    *   采用 iOS 风格的底部弹窗 (CupertinoActionSheet/CupertinoModalPopup) 进行选项选择
    *   使用圆角卡片容器，分隔线用于列表项
    *   遵循 iOS 配色方案 (SF Symbols 图标, #007AFF 强调色)
    *   统一使用 SafeArea 确保各平台显示正确
*   **深色模式:** 全平台必须完美适配深色模式 (Dark Mode)。
*   **主界面:** 
    *   列表页：展示图标（网站 favicon 或首字母）、标题、用户名/日期。
    *   详情页：清晰展示各字段，密码默认掩码显示，点击"眼睛"图标查看。
*   **图标缓存:** 网站 favicon 采用本地缓存，提升加载速度。

## 8. 后续规划 (Roadmap)
*   **P0 (MVP):**
    *   基础数据模型 (Vault/Item)。
    *   本地加密存储 (AES-256)。
    *   iCloud Drive (iOS/Mac) & SAF (Android) 同步适配。
    *   冲突解决机制。
    *   数据导入 (Import)。
*   **P1:**
    *   Linux 版本适配。
    *   生物识别解锁 (FaceID/Fingerprint)。
    *   密码历史记录 (Password History)。
    *   本地定期备份。
*   **P2:**
    *   附件/证书加密存储。
    *   TOTP/2FA 验证码生成器。
    *   Passkeys (FIDO2/WebAuthn) 支持。
*   **P3:**
    *   WebDAV 同步协议支持。

---

## 9. 开发进度 (Development Progress)

### 2026-02-27 更新

#### 已完成功能 ✅

| 功能 | 描述 | 状态 |
|------|------|------|
| **iCloud 同步** | Timer 轮询检测文件变化，自动刷新密码库，冲突时创建备份 | ✅ |
| **CSV 导入增强** | 自动检测表头，支持无表头 CSV，导入结果显示成功/失败数量 | ✅ |
| **批量删除** | 列表选择模式，多选后批量删除，删除前确认弹窗 | ✅ |
| **密码全屏显示** | 使用 SystemChrome 真正旋转屏幕，字符+位号上下显示，隔位换色 | ✅ |
| **生物识别优化** | 移除解锁页自动触发，添加详细错误提示（未注册/锁定/无密码） | ✅ |
| **自动锁定** | 使用 AppLifecycleState 检测后台/前台，切后台立即检查超时并锁定 | ✅ |
| **iOS 导航动画** | 改用 CupertinoPageRoute，实现 iOS 风格从右滑入动画 | ✅ |

#### 待解决问题 🔧

| 问题 | 描述 | 状态 |
|------|------|------|
| **真机崩溃** | 在真机上打开详情页→按 Home→重新打开 App→崩溃 | 🔄 调试中 |
| **真机部署** | 代码签名问题 (0xe8008014)，需在 Xcode 中配置 Development Team | 🔄 待解决 |

#### 技术细节

*   **密码放大显示**: 使用 `SystemChrome.setPreferredOrientations` 真正旋转屏幕，退出时先恢复竖屏再退出
*   **密码显示**: 每个字符 + 位号上下结构显示，隔位换色
*   **URL favicon**: 自动补全 `https://` 前缀，确保图标下载成功
*   **iCloud 同步**: Timer 轮询检测文件变化，通过比较 modification time 忽略自身修改

---

## 10. 风险与对策 (Risks & Mitigations)

| 风险 (Risk) | 可能性 (Likelihood) | 严重性 (Severity) | 对策 (Mitigation) |
| :--- | :--- | :--- | :--- |
| **同步冲突导致数据丢失** | 中 | 高 | 1. 强制采用“保留冲突副本”策略。<br>2. 每次写入前先校验文件 hash。<br>3. 保留本地历史快照 (Local Backup)。 |
| **用户主密码遗忘** | 低 | 极高 | 1. 支持生物识别重置: 设备有生物识别时，可通过生物验证重置密码。<br>2. 重建密码库: 无生物识别时，可清除旧数据创建新库（自动备份旧库）。<br>3. 首次设置时强制输入两次确认。 |
| **云服务不可用 (断网/API变更)** | 低 | 中 | 1. 优先读写本地缓存，离线可用。<br>2. 支持手动导出/导入文件作为备用方案。 |
| **云服务不可用 (断网/API变更)** | 低 | 中 | 1. 优先读写本地缓存，离线可用。<br>2. 支持手动导出/导入文件作为备用方案。 |
| **Android SAF 性能瓶颈** | 中 | 中 | 1. 针对大文件 (>5MB) 进行流式读写优化。<br>2. 仅在必要时全量加载，列表页仅加载元数据。 |
