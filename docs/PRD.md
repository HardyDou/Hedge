# 密码本 (NotePassword) 产品需求文档 (PRD)

**产品名称**: NotePassword (密码本)
**状态**: Draft (审核中)
**版本**: 1.3
**日期**: 2026-03-01
**Owner**: NotePassword Team

---

## 1. 问题与背景 (Problem & Context)

### 1.1 核心痛点 (The Problem)
目前的密码管理市场两极分化：
*   **商业软件 (1Password, LastPass):** 功能强大但订阅昂贵 ($2.99+/月)，且数据存储在厂商服务器，存在潜在的数据泄露风险 (如 2022年 LastPass 泄露事件)。
*   **开源软件 (KeePass, Bitwarden):** KeePass 体验较古老 (UI 停留在 2010 年代)，同步配置复杂；Bitwarden 自托管方案对用户有一定技术门槛。

**目标用户:**
*   拥护 "Local-First" 理念，不信任第三方云服务的隐私敏感用户。
*   拥有多设备 (如 MacBook + Android 手机) 需要跨平台同步的用户。
*   追求原生 UI 体验，厌倦 Electron 应用的性能敏感型用户。

### 1.2 为什么现在做？ (Why Now?)
1.  **用户隐私意识觉醒:** 2022-2025 年间，多起密码管理器数据泄露事件 (LastPass, Norton) 导致用户对"厂商云"失去信任，"Local-First" 软件架构成为新趋势。
2.  **云服务普及:** iCloud Drive 和各类手机厂商云服务已高度成熟，为"无服务器同步"提供了完美的基础设施。
3.  **跨平台需求:** 用户拥有多台设备（Mac + Android 手机）的场景日益普遍，需要一个轻量级的跨生态解决方案。
4.  **Flutter 成熟:** Flutter 已具备成熟的桌面端支持 (macOS/Linux/Windows)，可以一套代码横跨移动和桌面。

### 1.3 现有解决方案 (Current Solutions)
*   **1Password:** 体验完美，但贵 ($2.99/月)，数据存在厂商服务器。
*   **Bitwarden:** 开源便宜，但自托管门槛高，官方托管亦存在厂商风险。
*   **KeePass:** 免费开源，但 UI 老旧，移动端支持差。
*   **Chrome Password Manager:** 免费但仅限浏览器，无桌面/移动端体验。

---

## 2. 解决方案概览 (Solution Overview)

### 2.1 价值主张 (Value Proposition)
**NotePassword** 是一款 **"Local-First" (本地优先)** 的跨平台密码管理器。
它旨在为用户提供类似 1Password 的原生体验，但**完全去除**厂商云服务依赖。

*   **极致安全:** 数据文件由用户自己掌控 (iCloud Drive / Android SAF)，无任何厂商服务器中转。
*   **零成本:** 无订阅费，无服务器维护成本。
*   **原生体验:** 像素级的 iOS/macOS (Cupertino) 设计风格。

### 2.2 关键差异化 (Key Differentiators)
| 维度 | NotePassword | 1Password | Bitwarden | KeePass |
| :--- | :--- | :--- | :--- | :--- |
| **数据存储** | 用户自己的云盘 | 厂商服务器 | 厂商/自托管 | 本地/云盘 |
| **价格** | 免费 (开源) | $2.99+/月 | 免费/$10/年 | 免费 |
| **UI 体验** | 原生 Cupertino | 原生 | Web 风格 | 老旧 Win95 风格 |
| **跨平台** | Mobile + Desktop | Mobile + Desktop | Mobile + Desktop | 较弱 |

### 2.3 MVP 范围 (Scope - MVP)
**NotePassword MVP** 将专注于以下核心能力：
1.  **安全存储:** 主密码 + 生物识别解锁 + AES-256-GCM 加密。
2.  **基础 CRUD:** 密码条目的增删改查。
3.  **跨平台同步:** 基于 iCloud Drive (Apple) / SAF (Android) 的文件同步。
4.  **冲突处理:** "Keep Both" 策略。
5.  **导入:** Chrome CSV 导入。

### 2.4 明确不在范围内 (Out of Scope)
*   **团队共享/企业版:** MVP 阶段不支持多用户共享密码库。
*   **浏览器插件:** MVP 阶段暂不开发 Chrome/Safari 插件，优先保证 App 体验。
*   **云端备份:** 我们不提供任何云存储服务，用户必须自己负责数据的云端备份 (通过 iCloud/手机厂商云)。
*   **TOTP/2FA:** P2 阶段功能。
*   **Passkeys (FIDO2/WebAuthn):** P2 阶段功能。
*   **WebDAV 同步:** P3 阶段功能。

---

## 3. 成功指标 (Success Metrics)

### 3.1 北极星指标 (North Star Metric)
*   **净推荐值 (NPS):** > 40 (目标用户为技术敏感型用户，期望高于行业平均)

### 3.2 守护指标 (Guardrail Metrics)
| 指标 | 目标 | 告警阈值 |
| :--- | :--- | :--- |
| **冷启动速度 (移动端)** | < 1秒 | > 3秒 |
| **冷启动速度 (桌面端)** | < 2秒 | > 5秒 |
| **解锁后加载 1000 条密码** | < 500ms | > 2秒 |
| **同步成功率** | > 99.5% | < 99% |
| **同步延迟** | < 30秒 | > 2分钟 |
| **崩溃率 (Crash-free users)** | > 99.9% | < 99% |
| **列表定位时间** | < 3秒 | > 5秒 |
| **排序性能 (1000 条)** | < 100ms | > 500ms |

### 3.3 成功标准 (Success Criteria)
*   **数据零丢失:** 任何同步冲突场景下，必须保留冲突副本，绝不覆盖用户数据。
*   **迁移顺滑:** 从 Chrome 导入成功率 > 95%。
*   **列表导航:** 有 > 30% 的用户在 50+ 密码时使用字母索引功能。

---

## 4. 用户故事 (User Stories)

### 4.1 核心场景
*   **多设备同步:** 作为一名拥有 iPhone 和 MacBook 的用户，我想要在 Mac 上保存的密码自动出现在 iPhone 上，以便于我无需手动传输即可登录 APP。
*   **隐私掌控:** 作为一名注重隐私的用户，我想要确信我的密码库文件只存在于我信任的云盘中，而不被任何第三方应用开发商获取。
*   **桌面快速访问:** 作为一名桌面端用户，我想要通过菜单栏图标快速搜索并复制密码，以便于无需打开主窗口即可快速使用。
*   **一键导入:** 作为一名新用户，我想要一键导入我在 Chrome 浏览器保存的所有密码，以便于我能立即开始使用而无需手动输入。

### 4.2 安全场景
*   **自动锁定:** 作为一名用户，当我离开电脑或手机时，我希望应用自动锁定，以免他人窥探。
*   **生物识别重置:** 作为一名用户，当我忘记主密码且已开启生物识别时，我希望通过生物识别验证身份后重置密码，而不是直接丢失所有数据。

### 4.3 边缘场景 (Edge Cases)
*   **同步冲突:** 当我在两台设备同时修改了同一个账号密码时，我希望系统能保留两个版本并提示我，而不是悄悄覆盖掉其中一个。
*   **离线使用:** 当我处于没有网络的飞机上时，我希望能够正常查看和使用已缓存的密码库。

### 4.4 密码列表排序与索引

**Story 1: 密码列表排序**

作为用户，我希望密码按标题首字符统一排序（数字→字母→拼音），以便快速定位目标密码。

- [x] 数字开头的标题（如 "12306"）排在最前面
- [x] 英文字母开头的标题按 A-Z 顺序排列
- [x] 中文标题按拼音字母顺序排列（如"银行"在"测试"前面）
- [x] 排序在列表加载时自动应用，无需用户操作
- [x] 排序结果持久化（每次打开列表都保持一致顺序）

**Story 2: 移动端字母索引栏**

作为移动端用户，我希望通过右侧字母索引快速跳转到指定位置，无需大量滚动即可找到目标密码。

- [x] 右侧显示 A-Z + # 的垂直索引条
- [x] 手指触摸索引时显示对应的字母覆盖层（放大镜效果）
- [x] 拖动索引时列表实时滚动到对应位置
- [x] 索引只在密码数量 >= 20 时显示（避免小列表拥挤）
- [x] 索引支持滑动手势（快速扫过多个字母）

**Story 3: 桌面端排序**

作为桌面端用户，我希望密码按字母顺序排列，以便快速找到目标密码。

- [x] 桌面端密码列表自动按统一规则排序
- [x] 桌面端不需要字母索引（屏幕空间大，可直接滚动）

---

## 5. 用户体验 (User Experience)

### 5.1 首次体验 (Onboarding)
**目标:** 5 分钟内完成首次配置并进入主界面。

1.  **欢迎页:** 介绍核心价值 (安全、私有、无订阅)。
2.  **创建主密码:** 强制密码强度检查 (长度 + 复杂度)，提供本地化错误提示。
3.  **自动配置存储:** 程序自动选择并配置合适的存储路径 (iOS `Documents` / Android SAF)。
4.  **可选导入:** 成功后弹窗引导用户是否从 CSV 文件导入现有密码。
5.  **进入主界面。**

### 5.2 关键流程 (Key Flows)

#### 移动端 (iOS/Android)
```
解锁页 → 列表页 → 详情页 → 编辑页
         ↘ 设置页
```

列表页右侧常驻字母索引栏（密码数量 >= 20 时显示），手指触摸时弹出字母放大覆盖层，拖动时列表实时跳转至对应分组。

#### 桌面端 (macOS/Linux/Windows)
```
┌─────────────────────────────────────────────────────────────┐
│  [Icon] 密码本                    [+] 新建    [🔒] 锁定   │
├──────────────────┬──────────────────────────────────────────┤
│                  │                                          │
│  🔍 搜索...     │         选中项详情 / 空状态提示            │
│                  │                                          │
│  [网站图标]     │  ┌──────────────────────────────────┐    │
│  GitHub         │  │  Title                           │    │
│  user@...      │  │  👤 username              📋      │    │
│                  │  │  🔑 ••••••••              👁 📋  │    │
│  [网站图标]     │  │  🌐 github.com           📋       │    │
│  Apple         │  │  📝 Notes: ...                   │    │
│  apple@...    │  │                                  │    │
│                  │  └──────────────────────────────────┘    │
│  ...            │                                          │
│                  │  [✏️ 编辑]          [🗑️ 删除]          │
├──────────────────┴──────────────────────────────────────────┤
│  ⚙️ 设置                                                  │
└─────────────────────────────────────────────────────────────┘
   ↔️ 可拖拽分割线
```

### 5.3 设计原则 (Design Principles)
*   **原生体验:** 完全遵循 iOS 设计规范 (Apple Human Interface Guidelines)，采用 Cupertino Widgets。
*   **一致性:** 移动端和桌面端保持一致的设计语言。
*   **安全性:** 密码默认隐藏，点击可见；剪贴板复制后自动清除 (60秒)。
*   **无障碍:** 支持 VoiceOver (iOS) 和 TalkBack (Android)。

---

## 6. 技术需求 (Technical Requirements)

### 6.1 平台支持
| 平台 | 最低版本 | 备注 |
| :--- | :--- | :--- |
| **iOS** | iOS 15.0+ | Apple Silicon & Intel |
| **Android** | Android 10+ (API 29+) | 确保完善的 SAF 支持 |
| **macOS** | macOS 12.0+ | Apple Silicon & Intel |
| **Linux** | Ubuntu 20.04+, Arch Linux | AppImage/Flatpak |

### 6.2 性能需求
*   **列表滚动:** 保持 60fps (120fps on ProMotion)。
*   **大文件支持:** >5000 条目时需优化 (流式解密或懒加载)。
*   **内存占用:** 解锁后内存占用 < 200MB (5000 条目情况下)。
*   **排序性能:** 1000 条数据排序 < 100ms，不额外存储排序副本。
*   **索引响应:** 手势触发到列表滚动 < 16ms (60fps)。

### 6.3 安全与隐私
*   **加密算法:**
    *   密钥派生: **Argon2id** (Iterations: 3, Memory: 64MB, Parallelism: 4)
    *   数据加密: **AES-256-GCM**
*   **零知识架构:** 应用不上传任何明文数据。所有数据在写入存储前必须经过加密。
*   **内存安全:** 敏感数据 (密码明文、Session Key) 使用后及时清理。
*   **日志策略:** 严禁打印密码、密钥等敏感数据的明文日志。

### 6.4 同步机制 (Sync)
*   **策略:** 基于文件的同步 (File-based Sync)。
*   **监听:**
    *   iOS/macOS: Timer 轮询 iCloud Drive 文件元数据 (Modification Time)。
    *   Android: 依赖 SAF (Storage Access Framework) 文件流。
*   **冲突解决:**
    *   策略: **Keep Both**。
    *   实现: 检测到版本冲突时，自动将远程版本保存为 `vault_conflict_{timestamp}.db`，并提示用户。
*   **Offline Mode:**
    *   完全读写本地缓存文件。
    *   网络恢复后，由底层云服务 (iCloud/厂商云) 自动触发文件同步。

### 6.5 依赖包 (Dependencies)
*   **lpinyin:** 中文拼音排序，用于 SortService 实现统一排序规则（数字→字母→拼音）。

### 6.6 约束 (Constraints)
*   **无服务端:** 不搭建任何后端服务器，纯本地/云盘存储。
*   **无数据库:** 使用单加密 JSON 文件存储，避免引入 SQLite/Isar 增加同步复杂度。

---

## 7. 风险与对策 (Risks & Mitigations)

| 风险 (Risk) | 影响 | 对策 (Mitigation) |
| :--- | :--- | :--- |
| **同步冲突导致数据丢失** | 高 | 1. 强制采用"保留冲突副本"策略。<br>2. 每次写入前先校验文件 hash。<br>3. 保留本地历史快照 (Local Backup, 最近 5 份)。 |
| **用户主密码遗忘** | 极高 | 1. 支持生物识别重置: 设备有生物识别时，可通过生物验证重置密码。<br>2. 重建密码库: 无生物识别时，可清除旧数据创建新库 (自动备份旧库)。<br>3. 首次设置时强制输入两次确认。 |
| **云服务不可用 (断网/API变更)** | 中 | 1. 优先读写本地缓存，离线可用。<br>2. 支持手动导出/导入文件作为备用方案。 |
| **Android SAF 性能瓶颈** | 中 | 1. 针对大文件 (>5MB) 进行流式读写优化。<br>2. 仅在必要时全量加载，列表页仅加载元数据。 |
| **桌面端与移动端代码耦合** | 中 | 1. 严格遵循平台分离架构 (PageFactory 模式)。<br>2. 使用 shared 目录管理共享代码。 |
| **拼音排序性能问题** | 低 | 使用 lpinyin 包，必要时缓存排序结果。 |
| **字母索引手势冲突** | 中 | 使用 GestureDetector.excludeFromSemantics 避免与列表滚动冲突。 |

---

## 8. 待定问题 (Open Questions)

1.  **Q: 是否支持 Windows UWP (Microsoft Store) 发布？**
    *   A: 暂不在 MVP 范围，P1 阶段评估。

2.  **Q: 密码历史记录 (Password History) 存储多久？**
    *   A: 建议保留最近 10 个历史版本，超出后自动清理。

3.  **Q: 如何处理 "1Password" 的导入？**
    *   A: 1Password 的 `.1pux` 是加密 JSON 压缩包，解密逻辑较重，建议 P1 阶段实现。

4.  **Q: 字母索引的 VoiceOver/TalkBack 无障碍支持？**
    *   A: MVP 阶段暂不实现，Post-Launch 阶段补充。

---

## 9. 已完成功能归档 (Completed Features Archive)

### 9.1 同步功能 (v1.3.0 - 2026-03-01)

**实施状态**: ✅ 已完成并发布

**功能概述**:
- 支持三种同步模式：本地存储（默认）、iCloud Drive（iOS/macOS）、WebDAV（所有平台）
- WebDAV 支持坚果云、Nextcloud、Synology NAS 等标准 WebDAV 服务
- 自动冲突检测和备份机制（Keep Both 策略）
- 30 秒轮询检测远程变化
- 配置安全存储（FlutterSecureStorage）

**技术实现**:
- `lib/platform/webdav_sync_service.dart` - WebDAV 同步服务
- `lib/platform/ios_sync_service.dart` - iOS/macOS iCloud Drive 支持
- `lib/domain/models/sync_config.dart` - 同步配置模型
- `lib/presentation/pages/sync_settings_page.dart` - 同步设置界面

**用户价值**:
- 跨设备自动同步密码库
- 用户完全掌控数据（Local-First 理念）
- 零成本方案（WebDAV 可使用免费服务）

### 9.2 桌面版托盘快捷面板 (计划中)

**实施状态**: 📋 需求已确认，待开发

**功能概述**:
- 系统托盘/菜单栏常驻图标
- 点击托盘图标从图标位置弹出快捷操作面板
- 快捷面板包含：搜索框、密码列表、退出应用、打开主窗口
- 鼠标悬停密码条目时，一侧冒泡显示密码详情（账号、密码、备注）
- 详情冒泡支持：单个字段复制、密码显示/隐藏、密码放大显示
- 快捷面板与主窗口互相独立，仅同步解锁状态

**启动流程**:
1. 双击应用启动
2. 显示主窗口（正常启动流程）
3. 同时显示托盘图标
4. 用户可以关闭主窗口，应用缩到托盘继续运行

**快捷面板解锁逻辑**:
- **已解锁状态**：点击托盘图标，快捷面板直接显示密码列表
- **未解锁状态**：点击托盘图标，快捷面板显示解锁页面
  - 支持输入主密码解锁
  - 支持生物识别（指纹/Face ID）解锁
- **状态同步**：主窗口解锁后，快捷面板自动解锁；反之亦然
- **独立性**：除解锁状态外，快捷面板与主窗口完全独立（搜索、滚动位置、选中项等互不影响）

**交互细节**:
- **搜索过滤**：输入关键词实时过滤密码列表
- **悬停显示详情**：鼠标悬停在密码条目上时，列表一侧弹出详情冒泡窗口
- **详情内容**：与主窗口详情页面内容一致（标题、账号、密码、URL、备注）
- **快速操作**：
  - 每个字段旁有复制按钮（账号、密码、URL 等）
  - 密码字段支持显示/隐藏切换
  - 密码字段支持放大显示（大字体模式）
- **冒泡消失**：鼠标移出条目或详情区域时，冒泡自动消失

**技术方案**:
- 使用 `tray_manager` 创建系统托盘图标
- 使用 `window_manager` 创建独立 Panel 窗口（无边框、alwaysOnTop、skipTaskbar）
- 应用启动时显示主窗口 + 托盘图标
- 点击托盘图标显示/隐藏 Panel 窗口
- Panel 根据解锁状态显示不同内容（解锁页面 / 密码列表）
- 详情冒泡使用 Overlay 或 Tooltip 实现，跟随鼠标位置
- 解锁状态通过共享状态管理（Riverpod）同步
- 关闭 Panel 不退出主进程，与主窗口生命周期完全解耦
- **重要约束**：快捷面板使用独立窗口实现，主窗口不做任何改动

**预期价值**:
- 显著提升桌面端使用效率
- 后台常驻，随时快速访问密码
- 悬停即显示详情，无需点击进入详情页
- 减少操作步骤，快速复制任意字段
- 灵活的启动方式，适应不同使用习惯

**开发计划**:
- 优先级：**P0（最高优先级）**

### 9.3 拼音排序和字母索引 (v1.3.0 - 2026-03-01)

**实施状态**: ✅ 已完成并发布

**功能概述**:
- 统一排序规则：数字优先 → 英文/中文按拼音混排
- 移动端右侧字母索引栏（密码数 >= 20 时显示）
- 拖动索引实时跳转
- 预计算拼音优化性能（1000 条 < 100ms）

**技术实现**:
- `lib/domain/services/sort_service.dart` - 排序服务
- `lib/presentation/widgets/alphabet_index_bar.dart` - 字母索引组件
- 使用 `lpinyin` 包进行中文拼音转换
- `VaultItem.titlePinyin` 字段预存拼音

**用户价值**:
- 快速定位目标密码（大列表场景）
- 自然的排序体验（中英文混排）
- 流畅的滚动性能（60fps）

---

**文档状态:**
*   ✅ Product Strategy: Approved
*   ✅ Engineering: Approved (with notes on Sync & Key Derivation)
*   ✅ UX Design: Approved
*   **Version 1.4 (2026-03-02) - 添加已完成功能归档**
