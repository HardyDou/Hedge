# NotePassword æŠ€æœ¯é€‰å‹ä¸æ¶æ„è®¾è®¡ (Technical Architecture & Stack)

## 1. æ ¸å¿ƒç›®æ ‡ (Core Objectives)
*   **è·¨å¹³å°ä¸€è‡´æ€§:** ä»£ç å¤ç”¨ç‡ > 90% (iOS, Android, macOS, Linux)ã€‚
*   **é«˜æ€§èƒ½:** å¯åŠ¨é€Ÿåº¦ < 1sï¼Œåˆ—è¡¨æ»šåŠ¨æ»¡å¸§ (60/120fps)ã€‚
*   **åŸç”Ÿä½“éªŒ:** 
    *   ç¬¦åˆå„å¹³å°çš„è®¾è®¡è§„èŒƒ (Human Interface Guidelines / Material Design)ã€‚
    *   å®Œç¾æ”¯æŒæ·±è‰²æ¨¡å¼ã€æ— éšœç¢ã€ç³»ç»Ÿçº§å­—ä½“æ¸²æŸ“ã€‚
*   **å®‰å…¨:** å†…å­˜å®‰å…¨ï¼Œé¿å…å¸¸è§çš„ç¼“å†²åŒºæº¢å‡ºæ¼æ´ã€‚

---

## 2. æŠ€æœ¯æ ˆé€‰å‹ (Tech Stack)

### 2.1 åº”ç”¨æ¡†æ¶ (App Framework)
**ç»“è®º:** **Flutter**

**å¯¹æ¯”åˆ†æ:**
| ç»´åº¦ | Flutter | React Native | Tauri (Rust + Web) | Swift/Kotlin (åŸç”Ÿ) |
| :--- | :--- | :--- | :--- | :--- |
| **æ¸²æŸ“æ€§èƒ½** | â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸ (Skia è‡ªç»˜å¼•æ“ï¼Œåª²ç¾åŸç”Ÿ) | â­ï¸â­ï¸â­ï¸ (JS Bridge é€šä¿¡å¼€é”€) | â­ï¸â­ï¸â­ï¸ (WebView æ¸²æŸ“ï¼Œå†…å­˜å ç”¨ç•¥é«˜) | â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸ |
| **UI ä¸€è‡´æ€§** | â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸ (åƒç´ çº§ä¸€è‡´) | â­ï¸â­ï¸â­ï¸ (ä¾èµ–åŸç”Ÿç»„ä»¶ï¼Œå·®å¼‚å¤§) | â­ï¸â­ï¸â­ï¸ (Web æŠ€æœ¯ï¼Œæ˜“ç»Ÿä¸€æ ·å¼) | â­ï¸ (éœ€ç»´æŠ¤ä¸¤å¥— UI) |
| **å¼€å‘æ•ˆç‡** | â­ï¸â­ï¸â­ï¸â­ï¸ (å•ä»£ç åº“ï¼ŒHot Reload) | â­ï¸â­ï¸â­ï¸â­ï¸ (JS ç”Ÿæ€ä¸°å¯Œ) | â­ï¸â­ï¸â­ï¸ (Rust é—¨æ§›é«˜) | â­ï¸â­ï¸ (å·¥ä½œé‡ç¿»å€) |
| **æ¡Œé¢ç«¯æ”¯æŒ** | â­ï¸â­ï¸â­ï¸â­ï¸ (å·²æˆç†Ÿï¼Œç‰¹åˆ«æ˜¯ macOS/Linux) | â­ï¸â­ï¸ (æ¡Œé¢ç«¯æ”¯æŒè¾ƒå¼±/ç”±ç¤¾åŒºç»´æŠ¤) | â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸ (ä¸“ä¸ºæ¡Œé¢ä¼˜åŒ–) | â­ï¸â­ï¸ (ä»… macOS/Windows) |
| **åŒ…ä½“ç§¯** | ä¸­ç­‰ (çº¦ 10-20MB) | ä¸­ç­‰ | æå° (< 5MB) | å° |

**é€‰æ‹©ç†ç”±:**
*   **é«˜æ€§èƒ½æ¸²æŸ“:** Flutter çš„ Skia/Impeller å¼•æ“ç›´æ¥è°ƒç”¨ GPUï¼Œé¿å¼€äº† WebView çš„æ€§èƒ½ç“¶é¢ˆï¼Œç¡®ä¿äº†å¯†ç åˆ—è¡¨æ»šåŠ¨çš„æè‡´æµç•…ã€‚
*   **è·¨å¹³å°éœ¸ä¸»:** ç›®å‰å”¯ä¸€èƒ½åŒæ—¶åœ¨ Mobile (iOS/Android) å’Œ Desktop (macOS/Linux) æä¾›ç”Ÿäº§çº§æ”¯æŒçš„æ¡†æ¶ã€‚
*   **Dart è¯­è¨€:** å¼ºç±»å‹ã€ç©ºå®‰å…¨ (Null Safety)ï¼Œé€‚åˆç¼–å†™é«˜å¯é æ€§çš„å®‰å…¨åº”ç”¨ã€‚
*   **FFI æ”¯æŒ:** Dart FFI èƒ½é«˜æ•ˆè°ƒç”¨ Rust/C++ ç¼–å†™çš„åº•å±‚åŠ å¯†åº“ï¼Œå…¼é¡¾æ€§èƒ½ä¸å®‰å…¨ã€‚

### 2.2 æ ¸å¿ƒåŠ å¯†å±‚ (Core Crypto Layer)
**ç»“è®º:** **Dart (ä½¿ç”¨ `encrypt` å’Œ `cryptography` åº“)**

ä¸ºäº†ç®€åŒ– iOS ä¸Šçš„æ„å»ºæµç¨‹ï¼Œæ ¸å¿ƒåŠ å¯†é€»è¾‘å·²ä» Rust è¿ç§»åˆ°çº¯ Dart å®ç°ã€‚

*   **è¯­è¨€:** Dart (å¼ºç±»å‹ã€ç©ºå®‰å…¨)ã€‚
*   **åŠ å¯†åº“:** `cryptography` (PBKDF2, AES-256-GCM) å’Œ `encrypt` (AES-256-GCM)ã€‚
*   **å¯†é’¥æ´¾ç”Ÿ:** PBKDF2 (100,000 æ¬¡è¿­ä»£)ã€‚
*   **å†…å­˜ä¿æŠ¤:** Dart çš„åƒåœ¾å›æ”¶æœºåˆ¶è´Ÿè´£å†…å­˜ç®¡ç†ï¼Œæ•æ„Ÿæ•°æ®åœ¨ä¸å†ä½¿ç”¨æ—¶ä¼šè¢«æ ‡è®°ä¸ºå¯å›æ”¶ã€‚å°½ç®¡ä¸å¦‚ Rust çš„ `secrecy` ç²¾ç¡®æ§åˆ¶ï¼Œä½†å¯¹äºç°ä»£ Flutter åº”ç”¨è€Œè¨€ï¼Œè¿™é€šå¸¸æ˜¯å¯æ¥å—çš„æŠ˜è¡·æ–¹æ¡ˆã€‚

### 2.3 æ•°æ®å­˜å‚¨ (Storage)
**ç»“è®º:** **æŠ½è±¡å­˜å‚¨å±‚ (Repository Pattern) + é»˜è®¤ JSON åç«¯**

é‰´äº NotePassword çš„â€œæ–‡ä»¶å‹æ•°æ®åº“â€ç‰¹æ€§ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå•æ–‡ä»¶æ•°æ®åº“ã€‚ä¸ºäº†å…¼é¡¾å¼€å‘æ•ˆç‡ä¸æœªæ¥æ‰©å±•æ€§ï¼ˆå¦‚æ”¯æŒ >10k æ¡ç›®ï¼‰ï¼Œæˆ‘ä»¬å°†å®šä¹‰ä¸€ä¸ªé€šç”¨çš„ `VaultStorage` Traitã€‚

*   **æ¥å£å®šä¹‰ (Rust Trait):**
    ```rust
    trait VaultStorage {
        fn load(&self, key: &Secret<String>) -> Result<Vec<Item>>;
        fn save(&self, items: &[Item], key: &Secret<String>) -> Result<()>;
        fn merge(&self, other: &Self) -> Result<MergeResult>;
    }
    ```
*   **é»˜è®¤å®ç° (MVP): è‡ªå®šä¹‰åŠ å¯† JSON/MessagePack**
    *   **ä¼˜ç‚¹:** æ ¼å¼é€æ˜ï¼Œæ˜“äºå®ç°è·¨å¹³å°åŒæ­¥å’Œå†²çªåˆå¹¶ï¼ˆGit-like mergeï¼‰ã€‚
    *   **å®ç°:** Rust `serde` + `AES-GCM` æµå¼åŠ å¯†ã€‚
    *   **é™åˆ¶:** é€‚ç”¨äº < 10,000 æ¡ç›®ã€‚è‹¥è¶…è¿‡æ­¤æ•°é‡ï¼Œæ¶æ„å…è®¸æ— ç¼åˆ‡æ¢è‡³ SQLCipher å®ç°ã€‚
*   **ç»“æ„:** 
    ```json
    {
      "meta": { "uuid": "...", "ver": 1, "algo": "Argon2id+XChaCha20" },
      "data": "ENCRYPTED_BLOB_BASE64..." 
    }
    ```
*   åªæœ‰è§£å¯†åæ‰èƒ½è¯»å–å†…å®¹ï¼Œå…ƒæ•°æ®ï¼ˆç‰ˆæœ¬å·ã€UUIDã€Saltï¼‰æ˜æ–‡å­˜å‚¨ä»¥ä¾¿åŒæ­¥æ ¡éªŒã€‚

---

## 3. æ¶æ„è®¾è®¡ (Architecture)

é‡‡ç”¨ **MVVM (Model-View-ViewModel)** æ¶æ„ï¼Œç»“åˆ **Clean Architecture** åˆ†å±‚ç†å¿µã€‚**Dart Core å±‚ä½œä¸ºå•ä¸€å¯ä¿¡æº (Single Source of Truth)**ï¼Œç®¡ç†æ‰€æœ‰çŠ¶æ€ï¼ŒDart UI å±‚ä¸»è¦è´Ÿè´£ UI æ¸²æŸ“ã€‚

### 3.1 åˆ†å±‚æ¦‚è§ˆ
1.  **UI Layer (Flutter):**
    *   è´Ÿè´£æ¸²æŸ“ç•Œé¢ (Widgets)ã€‚ç›®å‰å·²å®Œå…¨è¿ç§»è‡³ **Cupertino UI**ã€‚
    *   å¤„ç†ç”¨æˆ·äº¤äº’ (Tap, Scroll)ã€‚
    *   **æ€§èƒ½ä¼˜åŒ–:**
        *   **å¼‚æ­¥æ¸²æŸ“:** æ‰€æœ‰æ¥è‡ª Rust çš„è€—æ—¶æ“ä½œï¼ˆå¦‚è§£å¯†ã€æœç´¢ï¼‰å¿…é¡»åœ¨ `compute()` æˆ–ç‹¬ç«‹çš„ **Isolate** ä¸­æ‰§è¡Œï¼Œç»ä¸é˜»å¡ UI çº¿ç¨‹ (Jank-Free)ã€‚
        *   **åˆ—è¡¨ä¼˜åŒ–:** å¼ºåˆ¶ä½¿ç”¨ `ListView.builder` + `const` æ„é€ å‡½æ•°ã€‚å¯¹äºå®šé«˜åˆ—è¡¨é¡¹ï¼Œè®¾ç½® `itemExtent` ä»¥è·³è¿‡å¸ƒå±€è®¡ç®—ã€‚
        *   **äº¤äº’ç»†èŠ‚:** iOS ä¸Šæ”¯æŒ "Interactive Keyboard Dismissal" (æ‹–åŠ¨éšè—é”®ç›˜)ï¼›Android ä¸Šé€‚é… "Edge-to-Edge" æ˜¾ç¤ºã€‚
    *   ä½¿ç”¨ `Riverpod` æˆ– `Bloc` ç›‘å¬æ¥è‡ª Dart çš„çŠ¶æ€æµã€‚
    *   **åŸåˆ™:** "Dumb View" â€”â€” UI ä¸åŒ…å«ä»»ä½•ä¸šåŠ¡é€»è¾‘ï¼Œåªè´Ÿè´£å±•ç¤ºçŠ¶æ€ã€‚
2.  **Logic Layer (Dart Core):**
    *   **State Management:** ç»´æŠ¤åº”ç”¨çŠ¶æ€ (Locked/Unlocked, Items List, Sync Status)ã€‚
    *   **Business Rules:** å¯†ç å¼ºåº¦æ ¡éªŒã€è¿‡æœŸæ£€æŸ¥ã€è‡ªåŠ¨é”å®šè®¡æ—¶å™¨ã€‚
    *   **Vault Manager:** è¯»å†™æ–‡ä»¶ã€è§£æ JSONã€å¤„ç†å†²çª (Merge Logic)ã€‚
        *   **Android SAF ä¼˜åŒ–:** é¿å…æ¯æ¬¡å¯åŠ¨é€’å½’æ‰«ææ–‡ä»¶å¤¹ã€‚é¦–æ¬¡æˆæƒåï¼Œç¼“å­˜ç›®æ ‡ Vault æ–‡ä»¶çš„ `document_uri`ï¼Œåç»­ç›´æ¥è¯»å†™è¯¥ URIã€‚
    *   **Crypto Engine:** åŠ å¯†/è§£å¯†/å¯†é’¥æ´¾ç”Ÿ (ä½¿ç”¨ Dart åŠ å¯†åº“)ã€‚
    *   **Shared Library (iOS Extension):** æ ¸å¿ƒé€»è¾‘å¿…é¡»ç¼–è¯‘ä¸ºé™æ€åº“ (`.a`) æˆ–åŠ¨æ€æ¡†æ¶ (`.framework`)ï¼Œä»¥ä¾¿ä¸» App å’Œ **AutoFill Credential Provider Extension** å…±äº«ä»£ç ã€‚æ³¨æ„ Extension å†…å­˜é™åˆ¶ (<120MB)ï¼ŒDart Core å¿…é¡»è½»é‡åŒ–ã€‚
3.  **Platform Services (Native/Flutter Plugin):**
    *   **iOS:** 
        *   `CloudKit` (Sync): ç»“åˆ `NSFilePresenter` å’Œ `NSMetadataQuery` (å‰å°ä¸»åŠ¨æŸ¥è¯¢) ç¡®ä¿æ•°æ®å®æ—¶æ€§ã€‚
        *   `FaceID` (Auth): ä½¿ç”¨ `LocalAuthentication` ç»“åˆ **Secure Enclave** å­˜å‚¨ä¸»å¯†ç çš„åŠ å¯†ä»¤ç‰Œï¼Œè€Œéç›´æ¥å­˜å‚¨å¯†ç ã€‚
        *   `AutoFill`: å®ç° `ASCredentialProviderViewController`ã€‚
    *   **Android:** 
        *   `SAF` (Storage), `BiometricPrompt` (Auth).
        *   `AutofillService`: å®ç° Android è‡ªåŠ¨å¡«å……æœåŠ¡ã€‚
    *   **Linux:** `SecretService` (Keyring), `Inotify` (File Watch)ã€‚

### 3.2 å…³é”®æµç¨‹è®¾è®¡

#### A. å¯åŠ¨æµç¨‹ (Cold Start)
1.  **Flutter UI:** æ˜¾ç¤ºå¯åŠ¨é¡µã€‚
2.  **Dart Core:** 
    *   è¯»å–é…ç½®æ–‡ä»¶ã€‚
    *   æ£€æŸ¥æ˜¯å¦å­˜åœ¨ä¸»æ•°æ®åº“æ–‡ä»¶ã€‚
    *   è‹¥å­˜åœ¨ -> è¿”å› `State: Locked`ã€‚
    *   è‹¥ä¸å­˜åœ¨ -> è¿”å› `State: Onboarding`ã€‚
3.  **Flutter UI:** è·³è½¬è‡³ `UnlockScreen` æˆ– `OnboardingScreen`ã€‚

#### B. è§£é”æµç¨‹ (Unlock)
1.  **UI:** ç”¨æˆ·è¾“å…¥ä¸»å¯†ç  æˆ– éªŒè¯ç”Ÿç‰©è¯†åˆ«ã€‚
2.  **Logic:** è°ƒç”¨ Dart `verify_master_password(pwd)`.
3.  **Dart Core:** 
    *   Argon2id å“ˆå¸Œè®¡ç®—ã€‚
    *   å°è¯•è§£å¯†æ•°æ®åº“å¤´ã€‚
    *   è‹¥æˆåŠŸ -> å°†æ´¾ç”Ÿçš„ `SessionKey` æš‚å­˜å†…å­˜ (Dart `SecretString`)ã€‚
    *   è§£å¯†ç´¢å¼•æ•°æ® (Titles, UUIDs) è¿”å›ç»™ Dartã€‚
4.  **UI:** å±•ç¤ºå¯†ç åˆ—è¡¨ã€‚

#### C. åŒæ­¥æµç¨‹ (Sync) - ä»¥ iOS iCloud ä¸ºä¾‹
1.  **Native (iOS):** `NSFilePresenter` ç›‘å¬åˆ° `cloud_vault.db` å‘ç”Ÿå˜æ›´ã€‚
2.  **Channel:** é€šçŸ¥ Flutter "File Changed"ã€‚
3.  **Flutter:** è°ƒç”¨ Dart `reload_and_merge()`ã€‚
4.  **Dart Core:** 
    *   è¯»å–æ–°æ–‡ä»¶ã€‚
    *   è§£å¯†ã€‚
    *   å¯¹æ¯”å†…å­˜ä¸­çš„æ•°æ®ç‰ˆæœ¬ã€‚
    *   è‹¥æœ‰å†²çª -> ç”Ÿæˆå†²çªå‰¯æœ¬ã€‚
    *   è‹¥æ— å†²çª -> æ›´æ–°å†…å­˜æ•°æ®ã€‚
5.  **Flutter:** åˆ·æ–° UI åˆ—è¡¨ã€‚

---

## 4. ç›®å½•ç»“æ„è§„åˆ’ (Project Structure)

```text
note-password/
â”œâ”€â”€ android/            # Android åŸç”Ÿå®¿ä¸»
â”œâ”€â”€ ios/                # iOS åŸç”Ÿå®¿ä¸»
â”œâ”€â”€ linux/              # Linux åŸç”Ÿå®¿ä¸»
â”œâ”€â”€ lib/                # Flutter Dart ä»£ç 
â”‚   â”œâ”€â”€ main.dart
â”‚   â”œâ”€â”€ core/           # æ ¸å¿ƒå·¥å…· (DI, Log, Config)
â”‚   â”œâ”€â”€ data/           # æ•°æ®å±‚ (Repository impl)
â”‚   â”œâ”€â”€ domain/         # ä¸šåŠ¡å®ä½“ (Models)
â”‚   â”œâ”€â”€ presentation/   # UI å±‚ (Pages, Widgets, Providers)
â”‚   â””â”€â”€ bridge_generated.dart # Rust FFI ç»‘å®š (å·²ç§»é™¤)
â”œâ”€â”€ native/             # Rust æ ¸å¿ƒåº“ (å·²ç§»é™¤)
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ api.rs      # æš´éœ²ç»™ Flutter çš„ API (å·²ç§»é™¤)
â”‚   â”‚   â”œâ”€â”€ crypto.rs   # åŠ å¯†é€»è¾‘ (å·²ç§»é™¤)
â”‚   â”‚   â”œâ”€â”€ vault.rs    # æ•°æ®å­˜å‚¨é€»è¾‘ (å·²ç§»é™¤)
â”‚   â”‚   â””â”€â”€ lib.rs
â”‚   â””â”€â”€ Cargo.toml
â”œâ”€â”€ assets/             # é™æ€èµ„æº (Fonts, Icons)
â””â”€â”€ pubspec.yaml
```

---

## 7. å½“å‰å®ç°çŠ¶æ€ (Implementation Status)

### 7.1 æ ¸å¿ƒåŠŸèƒ½ âœ…
*   ä¸»å¯†ç åˆ›å»ºä¸è§£é”
*   ç”Ÿç‰©è¯†åˆ«è§£é” (FaceID/TouchID/æŒ‡çº¹) - å·²ä¼˜åŒ–é”™è¯¯å¤„ç†
*   å¯†ç æ¡ç›® CRUD
*   å¯†ç æœç´¢
*   å¯†ç å¤åˆ¶åˆ°å‰ªè´´æ¿
*   é™„ä»¶ç®¡ç†

### 7.2 å®‰å…¨æ€§ âœ…
*   AES-256-GCM åŠ å¯†
*   Argon2id å¯†é’¥æ´¾ç”Ÿ
*   è‡ªåŠ¨é”å± (0-60ç§’å¯è°ƒ)
*   å¿˜è®°å¯†ç å¤„ç†

### 7.3 åŒæ­¥åŠŸèƒ½ âœ…
*   **iCloud åŒæ­¥**: Timer è½®è¯¢æ£€æµ‹æ–‡ä»¶å˜åŒ–ï¼Œè‡ªåŠ¨åˆ·æ–°å¯†ç åº“
*   **å†²çªè§£å†³**: æ£€æµ‹åˆ°å†²çªæ—¶è‡ªåŠ¨åˆ›å»ºå¤‡ä»½æ–‡ä»¶
*   **Android åŒæ­¥**: æ–‡ä»¶ç›‘æ§æ”¯æŒ

### 7.4 UI/UX (Cupertino é£æ ¼) âœ…
*   åˆ—è¡¨é¡µé¢ï¼šfavicon + é¦–å­—æ¯å›¾æ ‡ã€ç´§å‡‘å¸ƒå±€
*   è¯¦æƒ…é¡µé¢ï¼šåˆ†ç»„æ ·å¼ã€å¯†ç æ˜¾ç¤º/éšè—ã€æ”¾å¤§å¼¹çª—
*   è®¾ç½®é¡µé¢ï¼šiOS é£æ ¼åˆ†ç»„ã€åº•éƒ¨å¼¹çª—é€‰æ‹©
*   ä¸»é¢˜ï¼šè·Ÿéšç³»ç»Ÿ/æ·±è‰²/æµ…è‰²
*   å›½é™…åŒ–ï¼šä¸­/è‹±æ–‡
*   åº”ç”¨åç§°å¤šè¯­è¨€ï¼šiOS/macOS/Android å‡æ”¯æŒ
*   **å¯¼èˆªåŠ¨ç”»**: å·²æ”¹ç”¨ CupertinoPageRoute å®ç° iOS æ»‘åŠ¨æ•ˆæœï¼Œå¹¶ä¼˜åŒ–äº†è®¾ç½®é¡µé¢çš„è¿‡æ¸¡åŠ¨ç”»
*   **Material â†’ Cupertino è¿ç§»**: å·²å®Œæˆæ‰€æœ‰ Material ç»„ä»¶åˆ° Cupertino ç»„ä»¶çš„è¿ç§»ã€‚

### 7.5 æŠ€æœ¯å®ç°ç»†èŠ‚
*   **å¯†ç æ”¾å¤§æ˜¾ç¤º**: ä½¿ç”¨ `SystemChrome.setPreferredOrientations` çœŸæ­£æ—‹è½¬å±å¹•ï¼Œé€€å‡ºæ—¶å…ˆæ¢å¤ç«–å±å†é€€å‡º
*   **å¯†ç æ˜¾ç¤º**: æ¯ä¸ªå­—ç¬¦ + ä½å·ä¸Šä¸‹ç»“æ„æ˜¾ç¤ºï¼Œéš”ä½æ¢è‰²
*   **URL favicon**: è‡ªåŠ¨è¡¥å…¨ `https://` å‰ç¼€ï¼Œç¡®ä¿å›¾æ ‡ä¸‹è½½æˆåŠŸ
*   **åº”ç”¨åç§°**: ä½¿ç”¨å¹³å°åŸç”Ÿå›½é™…åŒ–æœºåˆ¶ (InfoPlist.strings / strings.xml)
*   **è‡ªåŠ¨é”å±**: ä½¿ç”¨ `WidgetsBindingObserver` ç›‘å¬ `AppLifecycleState.paused`ï¼Œç«‹å³æ£€æŸ¥è¶…æ—¶å¹¶é”å®š

### 7.6 å¾…å®Œæˆ
*   **çœŸæœºå´©æºƒè°ƒè¯•**: iOS çœŸæœºä¸Šæ‰“å¼€è¯¦æƒ…é¡µåæŒ‰ Home å†æ‰“å¼€å´©æºƒé—®é¢˜
*   **å¯†ç å†å²è®°å½•**: æŸ¥çœ‹ä¿®æ”¹å†å²

---

## 8. å·²çŸ¥é—®é¢˜ (Known Issues)

| é—®é¢˜ | æè¿° | å½±å“ | çŠ¶æ€ |
|------|------|------|------|
| çœŸæœºå´©æºƒ | æ‰“å¼€è¯¦æƒ…é¡µâ†’æŒ‰ Homeâ†’é‡æ–°æ‰“å¼€ Appâ†’å´©æºƒ | ä¸¥é‡ | ğŸ”„ è°ƒè¯•ä¸­ |
| ä»£ç ç­¾å | çœŸæœºéƒ¨ç½²æ—¶ç­¾åéªŒè¯å¤±è´¥ (0xe8008014) | ä¸¥é‡ | ğŸ”„ å¾…è§£å†³ |
| Material é£æ ¼ | ä»ä½¿ç”¨ Material ç»„ä»¶ï¼Œä¸ç¬¦åˆ iOS è®¾è®¡è§„èŒƒ | ä¸­ | âœ… å·²å®Œæˆè¿ç§» |

---

## 9. è·¨å¹³å°æ„å»ºæŒ‡å— (Build Guide)

### 6.1 ç»Ÿä¸€ä»£ç åº“ç­–ç•¥

Flutter æ¶æ„çš„æ ¸å¿ƒåœ¨äºï¼š
*   **One Codebase (`lib/`)**: åŒ…å«æ‰€æœ‰ UI å’Œä¸šåŠ¡é€»è¾‘ (Dart)ã€‚
*   **One Core (`native/`)**: åŒ…å«æ‰€æœ‰åŠ å¯†å’Œæ•°æ®é€»è¾‘ (Rust) - **å·²ç§»é™¤ï¼Œè¿ç§»è‡³ Dart**ã€‚
*   **Four Hosts (`android/`, `ios/`, `linux/`, `macos/`)**: è‡ªåŠ¨ç”Ÿæˆçš„"å£³"é¡¹ç›®ï¼Œæ‰¿è½½ Flutter/Dart ä»£ç ã€‚

### 6.2 æ„å»ºæµç¨‹

æ— éœ€ä¸ºæ¯ä¸ªå¹³å°ç¼–å†™ç‹¬ç«‹ä»£ç ã€‚åªéœ€åœ¨ `lib/` ä¸­ç¼–å†™ä»£ç ï¼Œç„¶åè¿è¡Œä¸åŒçš„æ„å»ºå‘½ä»¤ã€‚

#### iOS & macOS
*   **è¦æ±‚**: Mac + Xcode
*   **æ„å»ºå‘½ä»¤**:
    *   `flutter build ios` -> ç”Ÿæˆ `.ipa` (éœ€è¦ç­¾å)
    *   `flutter build macos` -> ç”Ÿæˆ `.app`
*   **Rust é›†æˆ**: `flutter_rust_bridge` è‡ªåŠ¨å°† Rust ä»£ç é“¾æ¥ä¸ºé™æ€åº“ (`.a`) - **å·²ç§»é™¤**ã€‚

#### Android
*   **è¦æ±‚**: Android Studio / SDK
*   **æ„å»ºå‘½ä»¤**: `flutter build apk` æˆ– `flutter build appbundle`
*   **Rust é›†æˆ**: `flutter_rust_bridge` ç¼–è¯‘ Rust ä¸º `.so` (JNI libs)ï¼Œæ‰“åŒ…è¿› APK - **å·²ç§»é™¤**ã€‚

#### Linux
*   **è¦æ±‚**: Linux æ„å»ºå·¥å…· (`build-essential`, `cmake`, `pkg-config`)
*   **æ³¨æ„**: macOS ä¸Šæ— æ³•ç›´æ¥æ„å»º Linuxï¼Œéœ€ä½¿ç”¨ Linux æœºå™¨æˆ– Docker/CIã€‚
*   **æ„å»ºå‘½ä»¤**: `flutter build linux`

### 6.3 Flutter ç‰ˆæœ¬ç®¡ç†

ä½¿ç”¨ `fvm` ç®¡ç† Flutter ç‰ˆæœ¬ï¼š
```bash
/Users/hardy/fvm/versions/stable/bin/flutter build macos
```

---

## 10. æŠ€æœ¯é‡æ„ç»éªŒæ€»ç»“ (Lessons Learned)

### 2026-02-27: Rust â†’ Dart è¿ç§»

#### èƒŒæ™¯
ç”±äº flutter_rust_bridge åœ¨ iOS çœŸæœºä¸Šçš„é“¾æ¥é—®é¢˜ï¼Œå°†åŠ å¯†æ ¸å¿ƒä» Rust è¿ç§»åˆ°çº¯ Dart å®ç°ã€‚

#### é‡åˆ°çš„é—®é¢˜åŠåŸå› 

| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| **æ–°å¢/ä¿®æ”¹åªä½œç”¨äºç¬¬ä¸€æ¡** | Dart ç‰ˆæœ¬çš„ `updateItem` å®ç°æœ‰ bugï¼Œä½¿ç”¨ `indexWhere` åç›´æ¥ä¿®æ”¹åˆ—è¡¨å¯¼è‡´å¼•ç”¨é—®é¢˜ | ä½¿ç”¨ `map` åˆ›å»ºæ–°åˆ—è¡¨ |
| **æ–°å¢æ—¶é‡å¤æ·»åŠ ** | `addItemWithDetails` å…ˆæ·»åŠ ç©º item å†æ›´æ–°ï¼Œå¯¼è‡´é‡å¤ | ç›´æ¥æ·»åŠ å®Œæ•´ item |
| **åŠ å¯†è§£å¯†ä¸ç¨³å®š** | æ‰‹å†™çš„ SHA256 å®ç°é”™è¯¯ | ä½¿ç”¨ cryptography åº“çš„ PBKDF2 |
| **setupVault ä½¿ç”¨ null å¯†ç ** | `state.currentPassword` åœ¨ setup æ—¶ä¸º null | ä½¿ç”¨ä¼ å…¥çš„ masterPassword å‚æ•° |

#### ç»éªŒæ•™è®­

1. **æ•°æ®æ¨¡å‹å¿…é¡»å®Œå…¨å…¼å®¹**
   - è¿ç§»å‰åæ•°æ®ç»“æ„ã€å­—æ®µåã€ç±»å‹å¿…é¡»ä¸€è‡´
   - ç‰¹åˆ«æ˜¯ UUIDã€æ—¶é—´æˆ³ç­‰å…³é”®å­—æ®µ

2. **å……åˆ†æµ‹è¯•**
   - å•å…ƒæµ‹è¯•å¿…é¡»è¦†ç›–æ‰€æœ‰ CRUD æ“ä½œ
   - é›†æˆæµ‹è¯•éªŒè¯ç«¯åˆ°ç«¯æµç¨‹

3. **æ¸è¿›å¼è¿ç§»**
   - ä¸è¦ä¸€æ¬¡æ€§é‡å†™æ•´ä¸ªåç«¯
   - å…ˆä¿æŒæ¥å£å…¼å®¹ï¼Œé€æ­¥æ›¿æ¢å®ç°

4. **ä¿ç•™æ—§ç‰ˆæœ¬æ•°æ®å¯¼å‡ºèƒ½åŠ›**
   - é‡å¤§ç‰ˆæœ¬å˜æ›´å‰æä¾›æ•°æ®å¯¼å‡º
   - é¿å…ç”¨æˆ·æ•°æ®ä¸¢å¤±

#### å½“å‰çŠ¶æ€
- âœ… åŠ å¯†æœåŠ¡å·²ç”¨ Dart é‡å†™
- âœ… ä½¿ç”¨ `encrypt` + `cryptography` åŒ…
- âœ… PBKDF2 (100000 iterations) + AES-256-GCM
- âœ… å·²æµ‹è¯•

### 2026-02-27: Material â†’ Cupertino UI è¿ç§»

#### èƒŒæ™¯
å°†åº”ç”¨ç¨‹åºçš„ UI ä» Material Design è¿ç§»åˆ° Apple çš„ Cupertino Designï¼Œä»¥æä¾›æ›´ç¬¦åˆ iOS å¹³å°è§„èŒƒå’Œç”¨æˆ·ä¹ æƒ¯çš„åŸç”Ÿä½“éªŒã€‚

#### é‡åˆ°çš„é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

| é—®é¢˜ | è§£å†³æ–¹æ¡ˆ |
|------|----------|
| **ç»„ä»¶æ›¿æ¢** | å°† `Scaffold`, `AppBar`, `AlertDialog`, `TextField`, `ElevatedButton`, `TextButton`, `FloatingActionButton`, `Switch`, `Slider`, `ListTile`, `Icons.X` ç­‰æ›¿æ¢ä¸ºå¯¹åº”çš„ `CupertinoPageScaffold`, `CupertinoNavigationBar`, `CupertinoAlertDialog`, `CupertinoTextField`, `CupertinoButton`, `CupertinoSwitch`, `CupertinoSlider`, `CupertinoListTile`, `CupertinoIcons.X`ã€‚ |
| **è‡ªå®šä¹‰å¯¼èˆªæ ** | å¯¹äº SettingsPage ç­‰éœ€è¦è‡ªå®šä¹‰å¯¼èˆªæ è¡Œä¸ºçš„é¡µé¢ï¼Œåˆ›å»º `_CustomNavBar` å°éƒ¨ä»¶ä»¥æä¾›ç»Ÿä¸€çš„è¿”å›æŒ‰é’®å’Œæ ‡é¢˜å±…ä¸­é€»è¾‘ï¼Œå¹¶å¤„ç† SafeAreaã€‚ |
| **é¡µé¢åŠ¨ç”»** | ç¡®ä¿æ‰€æœ‰é¡µé¢å¯¼èˆªéƒ½ä½¿ç”¨ `CupertinoPageRoute` ä»¥å®ç°æ­£ç¡®çš„ iOS é£æ ¼æ»‘åŠ¨åŠ¨ç”»ã€‚å¯¹äºéœ€è¦ä»å·¦ä¾§æ»‘å…¥çš„é¡µé¢ï¼ˆå¦‚è®¾ç½®é¡µé¢ï¼‰ï¼Œåˆ™ä½¿ç”¨ `SlideFromLeftRoute`ã€‚ |
| **header é®æŒ¡å†…å®¹** | åœ¨ `CupertinoPageScaffold` çš„ `child` ä¸­ï¼Œå°† `ListView` ç”¨ `SafeArea` åŒ…è£¹ï¼Œå¹¶ä¸º `ListView` æ·»åŠ  `padding: EdgeInsets.only(top: MediaQuery.of(context).padding.top + 44 + 32)` ä»¥é¿å…å†…å®¹è¢«è‡ªå®šä¹‰å¯¼èˆªæ å’ŒçŠ¶æ€æ é®æŒ¡ã€‚ |
| **å¼¹çª—æ ·å¼ä¸åè°ƒ** | å°† `showDialog` æ›¿æ¢ä¸º `showCupertinoDialog` å’Œ `showCupertinoModalPopup`ï¼Œå¹¶ä½¿ç”¨ `CupertinoAlertDialog` å’Œ `CupertinoActionSheet` ä»¥ä¿æŒè§†è§‰ä¸€è‡´æ€§ã€‚ä¾‹å¦‚ï¼Œè‡ªåŠ¨é”å±è¶…æ—¶è®¾ç½®ä»æ»‘å—æ”¹ä¸º Action Sheetã€‚ |
| **Toast æç¤º** | å°† `ScaffoldMessenger.of(context).showSnackBar` æ›¿æ¢ä¸º `showCupertinoDialog` å®ç°çš„ç®€çŸ­ `CupertinoAlertDialog`ï¼Œå¹¶åœ¨çŸ­æ—¶é—´åè‡ªåŠ¨å…³é—­ï¼Œæ¨¡æ‹Ÿ iOS çš„ Toast æç¤ºæ•ˆæœã€‚ |

#### ç»éªŒæ•™è®­

1.  **å…¨é¢å®¡æŸ¥:** åœ¨è¿›è¡Œå¤§è§„æ¨¡ UI æ¡†æ¶è¿ç§»æ—¶ï¼Œéœ€è¦å¯¹æ‰€æœ‰æ¶‰åŠçš„ UI ç»„ä»¶è¿›è¡Œç»†è‡´çš„å®¡æŸ¥å’Œæ›¿æ¢ï¼Œç¡®ä¿æ‰€æœ‰ Material ç»„ä»¶éƒ½è¢«æ­£ç¡®åœ°æ›¿æ¢ä¸º Cupertino å¯¹åº”é¡¹ã€‚
2.  **åŠ¨ç”»ä¸€è‡´æ€§:** ç¡®ä¿å¯¼èˆªåŠ¨ç”»ä¸å¹³å°è§„èŒƒä¸€è‡´ï¼Œé¿å…æ··ç”¨ Material å’Œ Cupertino çš„é¡µé¢è¿‡æ¸¡æ•ˆæœã€‚
3.  **SafeArea å¤„ç†:** åœ¨ä½¿ç”¨è‡ªå®šä¹‰å¯¼èˆªæ æˆ–å¸ƒå±€æ—¶ï¼Œéœ€è¦ä»”ç»†å¤„ç† `SafeArea` å’Œ `Padding`ï¼Œä»¥é˜²æ­¢å†…å®¹è¢«çŠ¶æ€æ æˆ–å¯¼èˆªæ é®æŒ¡ã€‚
4.  **å›½é™…åŒ–å…¼å®¹:** ç¡®ä¿åœ¨åˆ‡æ¢ UI ç»„ä»¶æ—¶ï¼Œå›½é™…åŒ–æ–‡æœ¬ï¼ˆå¦‚â€œBackâ€ï¼‰çš„æ˜¾ç¤ºå’Œæ ·å¼ä¿æŒæ­£ç¡®ã€‚

#### å½“å‰çŠ¶æ€
- âœ… æ‰€æœ‰ Material UI ç»„ä»¶å·²æˆåŠŸè¿ç§»åˆ° Cupertino UIã€‚
- âœ… å¯¼èˆªåŠ¨ç”»å’Œå¼¹çª—æ ·å¼å·²ä¸ iOS è§„èŒƒä¿æŒä¸€è‡´ã€‚
- âœ… è§£å†³äº†è®¾ç½®é¡µé¢å¤´éƒ¨å†…å®¹é‡å é—®é¢˜ã€‚
- âœ… æ„å»ºæˆåŠŸå¹¶é€šè¿‡åˆ†ææ£€æŸ¥ã€‚
