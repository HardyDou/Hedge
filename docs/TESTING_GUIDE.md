# 🧪 WebDAV 同步测试指南

## 测试前准备

### 方案 A: 使用坚果云（推荐，最简单）

1. **注册坚果云账号**
   - 访问: https://www.jianguoyun.com/
   - 注册免费账号（1GB 空间）

2. **生成应用密码**
   - 登录网页版
   - 点击右上角头像 → 账户信息
   - 安全选项 → 第三方应用管理
   - 添加应用，输入名称（如 "Hedge"）
   - **复制生成的应用密码**（重要！）

### 方案 B: 使用本地测试服务器（开发测试）

如果你有 Docker，可以快速启动一个 WebDAV 测试服务器：

```bash
docker run -d \
  --name webdav-test \
  -p 8080:80 \
  -e USERNAME=test \
  -e PASSWORD=test123 \
  bytemark/webdav
```

服务器地址: `http://localhost:8080/`
用户名: `test`
密码: `test123`

---

## 测试步骤

### 第一步：启动应用

```bash
cd /Users/hardy/Work/note-password
fvm flutter run -d macos
```

### 第二步：进入同步设置

1. 应用启动后，点击右上角的 **设置图标** ⚙️
2. 切换到 **数据** 标签页
3. 点击 **同步设置**

### 第三步：配置 WebDAV

#### 使用坚果云：

1. 点击 **WebDAV 同步** 卡片
2. 点击 **坚果云** 快速配置按钮
3. 填写信息：
   - **服务器地址**: `https://dav.jianguoyun.com/dav/` （已自动填写）
   - **用户名**: 你的坚果云邮箱
   - **密码**: 刚才复制的应用密码（不是登录密码！）
   - **远程路径**: `Hedge/vault.db` （已自动填写）
4. 点击 **测试连接**
5. 看到 ✅ "连接成功！" 后，点击 **保存并启用**

#### 使用本地测试服务器：

1. 点击 **WebDAV 同步** 卡片
2. 填写信息：
   - **服务器地址**: `http://localhost:8080/`
   - **用户名**: `test`
   - **密码**: `test123`
   - **远程路径**: `Hedge/vault.db`
3. 点击 **测试连接**
4. 看到 ✅ "连接成功！" 后，点击 **保存并启用**

### 第四步：测试上传

1. 返回主界面
2. 创建一个测试密码条目：
   - 标题: "测试密码"
   - 用户名: "test@example.com"
   - 密码: "test123"
3. 保存
4. 等待 30 秒（自动同步）

### 第五步：验证上传成功

#### 坚果云：
1. 登录坚果云网页版
2. 查看文件列表
3. 应该看到 `Hedge/vault.db` 文件
4. 检查文件修改时间是否是刚才

#### 本地测试服务器：
```bash
# 列出文件
curl -u test:test123 http://localhost:8080/

# 下载文件查看
curl -u test:test123 http://localhost:8080/Hedge/vault.db -o /tmp/vault.db
ls -lh /tmp/vault.db
```

### 第六步：测试下载（多设备同步）

#### 方案 A: 在同一台电脑上测试

1. 关闭应用
2. 删除本地 vault 文件：
   ```bash
   rm ~/Library/Containers/com.hardydou.hedge/Data/Documents/vault.db
   ```
3. 重新启动应用
4. 进入设置 → 同步设置 → 配置相同的 WebDAV
5. 应用会自动下载 vault.db
6. 输入主密码解锁
7. 验证是否看到之前创建的"测试密码"

#### 方案 B: 在另一台设备上测试

1. 在另一台 Mac/iPhone/iPad 上安装 Hedge
2. 进入设置 → 同步设置
3. 配置**相同的** WebDAV 信息
4. 保存并启用
5. 应用会自动下载 vault.db
6. 输入主密码解锁
7. 验证是否看到"测试密码"

### 第七步：测试自动同步

1. 在设备 A 上修改"测试密码"的备注：
   - 添加备注: "这是自动同步测试"
   - 保存
2. 等待 30 秒
3. 在设备 B 上等待 30 秒（自动检测远程变化）
4. 应用会自动重新加载
5. 验证是否看到新的备注

---

## 预期结果

### ✅ 成功标志

1. **连接测试成功**
   - 看到绿色的 ✅ "连接成功！" 消息

2. **上传成功**
   - 在 WebDAV 服务器上看到 `Hedge/vault.db` 文件
   - 文件大小 > 0
   - 文件修改时间正确

3. **下载成功**
   - 删除本地文件后能自动下载
   - 下载的数据完整
   - 能正常解锁和查看

4. **自动同步成功**
   - 一台设备修改后，另一台设备在 30 秒内自动更新
   - 数据一致

### ❌ 常见问题

#### 问题 1: "连接失败: Connection refused"

**原因**: 无法连接到服务器

**解决**:
- 检查服务器地址是否正确
- 检查网络连接
- 如果是本地测试服务器，确认 Docker 容器正在运行：
  ```bash
  docker ps | grep webdav
  ```

#### 问题 2: "连接失败: 401 Unauthorized"

**原因**: 用户名或密码错误

**解决**:
- 坚果云确认使用的是**应用密码**，不是登录密码
- 检查用户名是否正确
- 检查密码是否有多余空格

#### 问题 3: "连接失败: 404 Not Found"

**原因**: 服务器地址或路径错误

**解决**:
- 检查服务器地址末尾是否有 `/`
- 坚果云地址应该是: `https://dav.jianguoyun.com/dav/`

#### 问题 4: 看不到同步设置入口

**原因**: 应用版本不对

**解决**:
- 确认已经构建了最新版本
- 重新运行: `fvm flutter run -d macos`

#### 问题 5: 同步延迟

**原因**: 使用轮询机制，有 30 秒延迟

**解决**:
- 这是正常的，等待 30 秒即可
- 未来版本会支持实时同步

---

## 测试清单

### 基础功能
- [ ] 能进入同步设置页面
- [ ] 能进入 WebDAV 配置页面
- [ ] 快速配置模板能正常工作
- [ ] 表单验证正常（空字段、无效 URL）
- [ ] 密码显示/隐藏切换正常

### WebDAV 连接
- [ ] 坚果云连接测试成功
- [ ] 本地测试服务器连接成功
- [ ] 错误的密码会显示错误提示
- [ ] 错误的服务器地址会显示错误提示

### 上传功能
- [ ] 创建密码后能上传到服务器
- [ ] 服务器上的文件大小正确
- [ ] 文件修改时间正确
- [ ] 修改密码后能重新上传

### 下载功能
- [ ] 删除本地文件后能自动下载
- [ ] 下载的数据完整
- [ ] 能正常解锁
- [ ] 能看到所有密码条目

### 自动同步
- [ ] 一台设备修改后，另一台设备能自动更新
- [ ] 同步延迟在 30 秒左右
- [ ] 数据一致性正确

### 冲突处理
- [ ] 同时修改会创建冲突备份文件
- [ ] 备份文件命名正确（包含时间戳）

### UI/UX
- [ ] 桌面端能找到同步设置入口
- [ ] 移动端能找到同步设置入口
- [ ] 界面布局正常
- [ ] 错误提示清晰
- [ ] 成功提示清晰

---

## 性能测试

### 上传速度
```bash
# 记录开始时间
date

# 创建密码条目

# 等待上传完成（检查服务器）

# 记录结束时间
date

# 预期: < 5 秒
```

### 下载速度
```bash
# 记录开始时间
date

# 删除本地文件并重启应用

# 等待下载完成

# 记录结束时间
date

# 预期: < 5 秒
```

### 同步延迟
```bash
# 在设备 A 修改
date

# 在设备 B 看到更新
date

# 预期: 30-35 秒
```

---

## 清理测试环境

### 删除测试数据

```bash
# 删除本地 vault
rm ~/Library/Containers/com.hardydou.hedge/Data/Documents/vault.db

# 删除配置
# 在应用中：设置 → 同步设置 → 选择"仅本地存储"
```

### 停止测试服务器

```bash
docker stop webdav-test
docker rm webdav-test
```

### 删除坚果云测试文件

1. 登录坚果云网页版
2. 删除 `Hedge` 文件夹

---

## 下一步

测试通过后：

1. ✅ 合并到主分支
2. ✅ 更新版本号
3. ✅ 创建 Release
4. ✅ 更新文档

---

**祝测试顺利！** 🎉

有问题请查看：
- 完整文档: `docs/sync-implementation-complete.md`
- 快速开始: `docs/webdav-quick-start.md`
